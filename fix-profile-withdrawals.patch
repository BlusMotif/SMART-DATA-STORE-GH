--- a/src/server/routes.ts
+++ b/src/server/routes.ts
@@ -2097,18 +2097,24 @@ export async function registerRoutes(
       if (!agent.isApproved) {
         return res.status(403).json({ error: "Agent not approved" });
       }
-      // Validate user has sufficient profit wallet balance
-      const profitWallet = await storage.getProfitWallet(dbUser.id);
-      if (!profitWallet) {
-        return res.status(400).json({ error: "Profit wallet not found" });
-      }
-      const availableBalance = parseFloat(profitWallet.availableBalance);
+      
+      // Calculate available balance from agent's total profit minus withdrawals
+      const withdrawals = await storage.getWithdrawals({ userId: dbUser.id });
+      const withdrawnTotal = withdrawals
+        .filter(w => w.status === 'approved' || w.status === 'paid')
+        .reduce((s, w) => s + parseFloat((w.amount as any) || 0), 0);
+      
+      const totalProfit = parseFloat(agent.totalProfit || '0');
+      const availableBalance = Math.max(0, totalProfit - withdrawnTotal);
+      
+      console.log("Withdrawal validation:", {
+        totalProfit,
+        withdrawnTotal,
+        availableBalance,
+        requestedAmount: data.amount
+      });
+      
       if (availableBalance < data.amount) {
         return res.status(400).json({
-          error: "Insufficient profit wallet balance",
+          error: "Insufficient profit balance",
           balance: availableBalance.toFixed(2),
           requested: data.amount.toFixed(2)
@@ -2131,7 +2137,8 @@ export async function registerRoutes(
       });
     } catch (error: any) {
       console.error("Withdrawal error:", error);
-      res.status(400).json({ error: error.message || "Withdrawal failed" });
+      console.error("Error stack:", error.stack);
+      res.status(400).json({ error: error.message || "Withdrawal failed", details: process.env.NODE_ENV === 'development' ? error.stack : undefined });
     }
   });
 
@@ -1897,7 +1904,7 @@ export async function registerRoutes(
     } catch (error: any) {
       console.error("Profile error:", error);
       console.error("Error stack:", error.stack);
-      res.status(500).json({ error: "Failed to load profile" });
+      res.status(500).json({ error: "Failed to load profile", details: process.env.NODE_ENV === 'development' ? error.message : undefined });
     }
   });
   app.patch("/api/profile", requireAuth, async (req, res) => {
