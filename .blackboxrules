---
applyTo: '**'
---
Provide project context and coding guidelines that AI should follow when generating code, answering questions, or reviewing changes.You are working inside a production Vite + React + Node/Express + TypeScript project
that is deployed on Render.com.

Your task is to audit, fix, and harden the entire project so that:
1. It NEVER redirects users to localhost in production
2. It ALWAYS works on Render hosting without failed deploys
3. Routing, CSS, assets, ports, and environment variables are handled correctly
4. The app works identically in development and production (except base URLs)

STRICT REQUIREMENTS (DO NOT IGNORE):

### SERVER & PORT CONFIGURATION
- The backend MUST always bind to process.env.PORT
- Never hardcode ports like 3000, 5173, or 10000
- Use:
  const PORT = Number(process.env.PORT) || 3000
- Render injects PORT automatically — respect it everywhere
- Ensure only ONE server listens on the port

### ENVIRONMENT-AWARE URL HANDLING
- NEVER use "http://localhost" anywhere in production code
- Detect environment using:
  import.meta.env.PROD (frontend)
  process.env.NODE_ENV === "production" (backend)
- All redirects, callbacks, and API URLs must:
  - Use relative paths (preferred), OR
  - Dynamically resolve base URLs using environment variables
- Payment redirects MUST return to the deployed Render URL, not localhost

### ROUTING (VERY IMPORTANT)
- Fix all routing so that:
  - No page reloads redirect to localhost
  - SPA routing works on refresh (no 404 on direct URL access)
- Configure the backend to serve index.html for ALL non-API routes
- Ensure React Router (or equivalent) uses BrowserRouter correctly
- Do NOT use absolute URLs for internal navigation

### VITE CONFIGURATION (vite.config.ts)
- Ensure:
  - Correct base path ("/")
  - Assets and CSS load correctly in production
  - No preview-only config is required for production
- Fix any CSS or asset path issues causing distorted layouts
- Ensure build output is consistent with Render expectations

### CSS & ASSETS
- Fix all broken or missing CSS imports
- Ensure global styles are loaded once (main.tsx / index.tsx)
- Remove any CSS paths that depend on localhost or dev-only behavior
- Verify Tailwind / PostCSS / plain CSS builds correctly in production

### BUILD & OUTPUT
- Ensure TypeScript builds without errors
- Ensure build output directories match what the server expects
- Do NOT reference files that don’t exist after build
- Confirm the production start command runs the built server correctly

### RENDER SAFETY CHECKLIST (MANDATORY)
Before making changes, ALWAYS verify:
- Build command works on a clean install
- Start command points to the correct compiled file
- No dev-only dependencies are required at runtime
- No preview server is used in production
- No hardcoded hosts, ports, or localhost URLs exist

### DEPLOY-SAFE RULE
If any change might cause a Render deploy failure:
- STOP
- Fix the configuration first
- Prefer safe, standard, production patterns over hacks

### FINAL ACTION
- Apply fixes directly in the codebase
- Explain what was fixed and why
- Ensure the app deploys successfully on Render without manual intervention

DO NOT:
- Introduce localhost redirects
- Use vite preview in production
- Hardcode URLs, ports, or hosts
- Break existing production routing

Proceed carefully and professionally.
# Smart Data Store Ghana - AI Agent Instructions

## Architecture Overview
This is a monorepo full-stack application with separate client and server builds:
- **Client**: React 18 + TypeScript + Vite (SPA in `client/` folder)
- **Server**: Express.js + TypeScript (API in `server/` folder)
- **Shared**: TypeScript schemas and types (`shared/schema.ts`)
- **Database**: PostgreSQL via Supabase with Drizzle ORM
- **Auth**: Supabase JWT-based authentication
- **Payments**: Paystack integration
- **Deployment**: Render (production server)

## Key Components & Data Flow
```
Client (React/Vite) → Express API → Storage Layer → Drizzle ORM → PostgreSQL
                      ↓
                 Supabase Auth (JWT validation)
                      ↓
               Paystack API (payments)
```

## Critical Developer Workflows

### Build & Run Commands
- `npm run dev`: Start development server (tsx watches server/, Vite serves client/)
- `npm run build`: Build both client (to `dist/public/`) and server (to `dist/server/`)
- `npm start`: Run production server from `dist/server/index.js`
- `npm run db:push`: Apply database schema changes via Drizzle

### ESM Module System
- All imports must use `.js` extensions in TypeScript source files
- Example: `import { apiRequest } from "./queryClient.js";`
- Server compiles from `server/` to `dist/server/` with proper extensions

### Environment Configuration
- Use `process.env.VARIABLE_NAME` for server-side config
- Client-side: Define constants in `client/src/lib/constants.ts`
- Never hardcode URLs - use environment variables or `window.location.origin`

## Project-Specific Patterns

### Role-Based System
User roles: `guest` → `user` → `agent` → `dealer` → `super_dealer` → `admin`
- Role-based pricing: Data bundles have `basePrice`, `agentPrice`, `dealerPrice`, `superDealerPrice`
- Access control: Check `user?.role` before rendering features
- Example: `if (user?.role === 'admin') { /* admin features */ }`

### File Organization
- **Client components**: `client/src/components/` (ui/, layout/, products/, user/)
- **Pages**: `client/src/pages/` (admin/, agent/, user/, products/)
- **Server routes**: All API endpoints in `server/routes.ts`
- **Database operations**: `server/storage.ts` (CRUD operations)
- **Shared types**: `shared/schema.ts` (Drizzle schemas, Zod validation)

### API Patterns
- RESTful endpoints with role-based middleware (`requireAuth`, `requireAdmin`)
- Error handling: Return JSON `{ error: "message" }` with appropriate status codes
- Authentication: JWT tokens via Supabase, validated in middleware

### Database Patterns
- Use Drizzle ORM for type-safe queries
- Relations defined in schema files
- Migrations in `migrations/` folder
- Example: `await storage.getDataBundles({ network, isActive: true })`

### Payment Integration
- Wallet system: Users have balances, instant deductions
- Paystack: External payments with webhooks
- Always validate amounts and user balances before transactions

## Common Pitfalls to Avoid
- Don't import without `.js` extensions in server TypeScript files
- Don't hardcode localhost URLs - use environment variables
- Don't mix client and server code - keep them separate
- Don't forget to update both client and server when changing shared types
- Don't deploy without running `npm run build` first

## Key Files to Reference
- `shared/schema.ts`: All database schemas, types, and validations
- `server/routes.ts`: API endpoint definitions and business logic
- `server/storage.ts`: Database operations and queries
- `client/src/lib/constants.ts`: Client-side configuration
- `package.json`: Build scripts and dependencies