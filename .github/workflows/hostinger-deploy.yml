name: Deploy to Hostinger

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
    
    - name: Build server
      run: npm run build:server
    
    - name: Build frontend
      run: npm run build:client
    
    - name: Verify builds exist
      run: |
        echo "Checking server build..."
        test -f dist/server/index.js || (echo "‚ùå Server build failed - dist/server/index.js not found" && exit 1)
        echo "‚úÖ Server build found"
        
        echo "Checking frontend build..."
        test -d dist/public || (echo "‚ùå Frontend build failed - dist/public not found" && exit 1)
        test -f dist/public/index.html || (echo "‚ùå Frontend index.html not found" && exit 1)
        echo "‚úÖ Frontend build found"
        
        echo "Checking entry point..."
        test -f index.js || (echo "‚ùå Entry point index.js not found" && exit 1)
        echo "‚úÖ Entry point found"
    
    - name: Run syntax check
      run: node --check dist/server/index.js
    
    - name: Prepare deployment package
      run: |
        echo "üì¶ Creating deployment package..."
        
        # Ensure .htaccess is in dist/public for Hostinger
        cp .htaccess dist/public/.htaccess 2>/dev/null || true
        
        # Create startup verification file
        echo "Deployed: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" > dist/DEPLOYMENT_INFO.txt
        echo "Commit: ${{ github.sha }}" >> dist/DEPLOYMENT_INFO.txt
        echo "Branch: ${{ github.ref_name }}" >> dist/DEPLOYMENT_INFO.txt
        
        echo "‚úÖ Deployment package ready"
    
    - name: Deployment Ready
      run: |
        echo "‚úÖ Build successful!"
        echo ""
        echo "üìã Hostinger Business Plan Setup:"
        echo "=================================="
        echo ""
        echo "1Ô∏è‚É£  In Hostinger hPanel ‚Üí Websites ‚Üí Manage"
        echo "2Ô∏è‚É£  Go to Advanced ‚Üí Node.js"
        echo "3Ô∏è‚É£  Connect your GitHub repository: ${{ github.repository }}"
        echo ""
        echo "4Ô∏è‚É£  Configure Node.js Application:"
        echo "   ‚Ä¢ Node.js Version: 20.x"
        echo "   ‚Ä¢ Application Root: / (root)"
        echo "   ‚Ä¢ Entry Point: index.js"
        echo "   ‚Ä¢ Build Command: npm run build"
        echo "   ‚Ä¢ Start Command: npm start"
        echo ""
        echo "5Ô∏è‚É£  Add Environment Variables in hPanel:"
        echo "   DATABASE_URL=postgresql://..."
        echo "   SUPABASE_URL=https://..."
        echo "   SUPABASE_SERVICE_ROLE_KEY=..."
        echo "   NODE_ENV=production"
        echo "   SESSION_SECRET=your-secret-key"
        echo "   PAYSTACK_PUBLIC_KEY=..."
        echo "   PAYSTACK_SECRET_KEY=..."
        echo ""
        echo "6Ô∏è‚É£  Click 'Deploy' in Hostinger hPanel"
        echo ""
        echo "‚úÖ Auto-deploy is enabled for pushes to main branch"
